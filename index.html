<!DOCTYPE html>
<html>

<head>
    <title>Family Chores</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="bootstrap.min.css">
    <script src="bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="style/style.css">
</head>




<body class="bg-light">
    <div class="container py-4">

        <!-- Project Info -->
        <div class="mb-4">
            <p>
                For more information about this project, please visit
                <a href="https://github.com/kamarkseit/project-chores.git" target="_blank" class="link-primary">
                    my GitHub page
                </a>.
            </p>
            <button class="btn btn-primary"
                onclick="window.location.href='https://us-east-29mfui02s1.auth.us-east-2.amazoncognito.com/login/continue?client_id=6vglcr32jduh2rtn0uefn5pj5d&redirect_uri=https%3A%2F%2Fkamarkseit.github.io%2Fproject-chores%2F&response_type=token&scope=email+openid+phone+profile'">
                Login/Create Login
            </button>
            <button class="btn btn-secondary" id="logoutBtn">
                Logout
            </button>

        </div>

        <div class="row">
            <!-- History Log -->
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h1 class="h4 mb-0">History Log</h1>
                    </div>
                    <div class="card-body">
                        <p class="mb-2">Please see all chores completed this month.</p>
                        <div id="history-log" class="alert alert-warning"></div>
                    </div>
                </div>
            </div>

            <!-- Due Chores Log -->
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header bg-danger text-white">
                        <h1 class="h4 mb-0">Due Chores</h1>
                    </div>
                    <div class="card-body">
                        <p class="mb-2">These chores are currently due or overdue.</p>
                        <div id="due-chores-log" class="alert alert-warning"></div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Job Update Section -->
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h2 class="h5 mb-0">Update My Job</h2>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="participant-select" class="form-label">Choose a participant:</label>
                    <select id="participant-select" class="form-select">
                        <option value="">------Select------</option>
                    </select>
                </div>
                <div id="job-update-area"></div>
            </div>
        </div>


        <!-- Analytics Section -->
        <div class="card mt-4">
            <div class="card-header bg-info text-white">
                <h2 class="h5 mb-0">Analytics</h2>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Chart 1 -->
                    <div class="col-md-6 mb-4">
                        <canvas id="choresByPerson"></canvas>
                    </div>
                    <!-- Chart 2 -->
                    <div class="col-md-6 mb-4">
                        <canvas id="choresOverTime"></canvas>
                    </div>
                </div>
                <div class="row">
                    <!-- Chart 3 -->
                    <div class="col-md-12">
                        <canvas id="avgCompletion"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Update Chore Section -->
        <div class="card mt-4">
            <div class="card-header bg-warning text-dark">
                <h2 class="h5 mb-0">Update Family Chore List</h2>
            </div>
            <div class="card-body">
                <!-- Trigger button -->
                <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal"
                    data-bs-target="#updateChoreModal">
                    Edit Chore
                </button>
                <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal"
                    data-bs-target="#addChoreModal">
                    Create A New Chore
                </button>

                <!-- Modal1 -->
                <div class="modal fade" id="updateChoreModal" tabindex="-1" aria-labelledby="updateChoreLabel"
                    aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title" id="updateChoreLabel">Edit Chore Details</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="updateChoreForm">
                                    <div class="mb-3">
                                        <label for="choreIdSelect" class="form-label">Choose Chore ID</label>
                                        <select class="form-select" id="choreIdSelect">
                                            <option value="">-- Select a chore --</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="choreName" class="form-label">Chore Name</label>
                                        <input type="text" class="form-control" id="choreName" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="choreInstr" class="form-label">Instruction</label>
                                        <textarea class="form-control" id="choreInstr" rows="3"></textarea>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="dueDate" class="form-label">Due Date</label>
                                            <input type="date" class="form-control" id="dueDate" name="dueDate"
                                                required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="interval" class="form-label">Interval Days</label>
                                            <select class="form-select" id="interval">
                                                <option value="7">7</option>
                                                <option value="14">14</option>
                                                <option value="21">21</option>
                                                <option value="28">28</option>
                                                <option value="60">60</option>
                                                <option value="90">90</option>
                                                <option value="120">120</option>
                                                <option value="180">180</option>
                                                <option value="360">360</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="assignedTo" class="form-label">Assigned To</label>
                                            <input type="text" class="form-control" id="assignedTo" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="theirEmail" class="form-label">Their Email</label>
                                            <input type="text" class="form-control" id="theirEmail" required>
                                        </div>
                                    </div>
                                    <input type="hidden" id="choreId">
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" form="updateChoreForm" class="btn btn-success">Save
                                    Changes</button>
                                <button type="button" class="btn btn-danger ms-auto" id="deleteChoreBtn">Delete
                                    Chore</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Modal2 -->
                <div class="modal fade" id="addChoreModal" tabindex="-1" aria-labelledby="addChoreLabel"
                    aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title" id="addChoreLabel">New Chore Details</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="addChoreForm">
                                    <div class="mb-3">
                                        <label for="choreIdNew" class="form-label">New Chore ID</label>
                                        <input type="number" class="form-control" id="choreIdNew" readonly>
                                    </div>
                                    <div class="mb-3">
                                        <label for="choreNameNew" class="form-label">Chore Name</label>
                                        <input type="text" class="form-control" id="choreNameNew" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="choreInstrNew" class="form-label">Instruction</label>
                                        <textarea class="form-control" id="choreInstrNew" rows="3"></textarea>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="dueDateNew" class="form-label">Due Date</label>
                                            <input type="date" class="form-control" id="dueDateNew" name="dueDateNew"
                                                required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="intervalNew" class="form-label">Interval Days</label>
                                            <select class="form-select" id="intervalNew">
                                                <option value="7">7</option>
                                                <option value="14">14</option>
                                                <option value="21">21</option>
                                                <option value="28">28</option>
                                                <option value="60">60</option>
                                                <option value="90">90</option>
                                                <option value="120">120</option>
                                                <option value="180">180</option>
                                                <option value="360">360</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="assignedToNew" class="form-label">Assigned To</label>
                                            <input type="text" class="form-control" id="assignedToNew" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="theirEmailNew" class="form-label">Their Email</label>
                                            <input type="text" class="form-control" id="theirEmailNew" required>
                                        </div>
                                    </div>
                                    <input type="hidden" id="choreIdNew">
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" form="addChoreForm" class="btn btn-success">Save
                                    New Chore</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>




    <script>
        // --- Loading overlay with blur and spinner ---
        function showLoader() {
            document.body.classList.add("loading");
            document.getElementById("loading-overlay").classList.add("active");
        }

        // --- Loading overlay with blur and spinner ---
        function hideLoader() {
            document.body.classList.remove("loading");
            document.getElementById("loading-overlay").classList.remove("active");
        }

        // --- Toast message function ---
        function showToast(message) {
            const container = document.querySelector(".toast-container")
                || (() => {
                    const c = document.createElement("div");
                    c.className = "toast-container position-fixed bottom-0 end-0 p-3";
                    document.body.appendChild(c);
                    return c;
                })();

            const toast = document.createElement("div");
            toast.className = "toast align-items-center text-bg-success border-0";
            toast.role = "alert";
            toast.innerHTML = `
                <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>`;

            container.appendChild(toast);

            // Initialize and show using Bootstrap’s API
            const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
            bsToast.show();

            // Clean up after hidden
            toast.addEventListener("hidden.bs.toast", () => toast.remove());
        }

        // --- Get token from API Gateway and Cognito ---
        function getTokenFromUrl() {
            const hash = window.location.hash;
            return new URLSearchParams(hash.substring(1)).get('id_token');
        }

        // --- Fetch json data that is stored in DynamoDB using API Gateway and Cognito ---
        async function fetchData() {
            // Remove both jsons from the local storage to save updated versions
            localStorage.removeItem("currentChores");
            localStorage.removeItem("completedChores");

            const token = localStorage.getItem("idToken");
            if (!token) {
                alert("Please log in to view chores.");
                return { currentChores: [], completedChores: [] };
            }

            let currentChores = [];
            let completedChores = [];

            try {
                // document.getElementById("history-log").classList.add("spinner-border");
                // document.getElementById("history-log").innerText = "";
                // document.getElementById("due-chores-log").classList.add("spinner-border");
                // document.getElementById("due-chores-log").innerText = "";
                // document.getElementById("choresByPerson").classList.add("spinner-border");
                // document.getElementById("choresByPerson").innerText = "";
                // document.getElementById("choresOverTime").classList.add("spinner-border");
                // document.getElementById("choresOverTime").innerText = "";
                // document.getElementById("avgCompletion").classList.add("spinner-border");
                // document.getElementById("avgCompletion").innerText = "";
                showLoader();
                const response = await fetch("https://d75p3zw6y5.execute-api.us-east-2.amazonaws.com/prod/update-json", {
                    method: "GET",
                    headers: {
                        'Content-Type': 'application/json',
                        "Authorization": `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    const data = result.chores || [];   // unified array with status field

                    // Separate current vs completed data
                    currentChores = data.filter(chore => chore.status === "current");
                    completedChores = data.filter(chore => chore.status === "completed");

                    localStorage.setItem("currentChores", JSON.stringify(currentChores));
                    localStorage.setItem("completedChores", JSON.stringify(completedChores));
                    hideLoader();
                    // document.getElementById("history-log").classList.remove("spinner-border");
                    // document.getElementById("due-chores-log").classList.remove("spinner-border");
                    // document.getElementById("choresByPerson").classList.remove("spinner-border");
                    // document.getElementById("choresOverTime").classList.remove("spinner-border");
                    // document.getElementById("avgCompletion").classList.remove("spinner-border");
                }
            } catch (err) {
                console.log("Error fetching data in fetchData", err);
            }

            return { currentChores, completedChores };
        }

        // Refreshing User Interface function
        async function refreshUI() {
            const { currentChores, completedChores } = await fetchData();
            pollForResults(currentChores, completedChores);
        }

        // Function is used to modify data and send it to S3 using API Gateway
        async function markComplete(jobId) {
            const token = localStorage.getItem('idToken');
            if (!token) {
                alert("Please log in to mark chores complete.");
                return;
            }

            // Grab the Date Input Inside
            const input = document.getElementById(`date-${jobId}`);
            const newDate = input.value;
            if (!newDate) {
                alert("Please select a date.");
                return;
            }

            // Grab the data from local storage
            const stored = localStorage.getItem("currentChores");
            const data = stored ? JSON.parse(stored) : [];
            // Recalculate the nextDue date
            const nextDue = new Date(newDate); // Convert string to Date object
            // Recalculate days that a completed chore was overdue before marked complete
            const nowCompleted = new Date(newDate);
            const msPerDay = 1000 * 60 * 60 * 24;

            // Update the values in the data
            const updated = data.map(entry => {
                if (entry.chore_id === jobId) {
                    const lastDue = new Date(entry.next_due); // from JSON
                    const diffInDays = Math.floor((nowCompleted - lastDue) / msPerDay);
                    entry.last_completed_with_DOD = diffInDays;
                    entry.last_completed = newDate;
                    entry.chore_status = "complete";
                    nextDue.setDate(nextDue.getDate() + entry.interval_days); // Add interval
                    entry.next_due = nextDue.toISOString().split("T")[0]; // Format as "YYYY-MM-DD"
                    entry.days_overdue = 0;
                }
                return entry;
            });

            //11052025: sending only complete item to s3 instead of the entire chores.json:
            const updatedItem = updated.find(entry => entry.chore_id === jobId);

            try {
                const response = await fetch('https://d75p3zw6y5.execute-api.us-east-2.amazonaws.com/prod/update-json', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(updatedItem)
                });

                const result = await response.json();
                console.log('Success:', result);

                showToast("Chore marked complete ✅");
                document.getElementById("job-update-area").innerHTML = ""; // Clear previous

                // Now refresh after the update has finished
                setTimeout(() => {
                    refreshUI();
                }, 3000);

            } catch (error) {
                console.error('Error:', error);
            }
        }

        function showJobsForParticipant(data, name) {
            const container = document.getElementById("job-update-area");
            container.innerHTML = ""; // Clear previous

            const jobs = data.filter(entry => entry.assigned_to === name && entry.chore_status === "due");

            if (jobs.length === 0) {
                container.textContent = "No jobs assigned to " + name;
                return;
            }

            jobs.forEach(job => {
                const today = new Date().toISOString().split('T')[0];
                const div = document.createElement("div");
                //markComplete is used below
                div.innerHTML = `
                    <p><strong>${job.chore_name}</strong> (Last done: ${job.last_completed})</p>
                    <label for="date-${job.chore_id}">Mark as complete:</label>
                    <input type="date" id="date-${job.chore_id}" max="${today}">
                    <button onclick="markComplete(${job.chore_id})">Update</button> 
                `;
                container.appendChild(div);
            });
        }

        function pollForResults(currentChores, completedChores) {
            // Find today's date, month, and year.
            const now = new Date();
            const currentMonth = now.getMonth(); // 0-indexed: October = 9
            const currentYear = now.getFullYear();


            // --- History log logic ---
            const historyContainer = document.getElementById("history-log");
            historyContainer.innerHTML = "";
            const history_log = [];

            completedChores.forEach(entry => {
                const completedDate = new Date(entry.completed_on + "T00:00:00Z");
                if (
                    completedDate.getUTCMonth() === currentMonth &&
                    completedDate.getUTCFullYear() === currentYear
                ) {
                    history_log.push(`${entry.completed_on}: ${entry.chore_name} by ${entry.assigned_to}`);
                }
            });

            history_log.sort();
            historyContainer.innerHTML = history_log.length === 0
                ? "No job was completed this month."
                : `<ul>${history_log.map(job => `<li>${job}</li>`).join('')}</ul>`;


            // --- Due Chores log logic ---
            const dueContainer = document.getElementById("due-chores-log");
            dueContainer.innerHTML = "";
            const due_log = [];

            currentChores.forEach(entry => {
                if (entry.chore_status === "due") {
                    due_log.push(`${entry.chore_name} is ${entry.days_overdue} days overdue for ${entry.assigned_to}`);
                }
            });

            dueContainer.innerHTML = due_log.length === 0
                ? "No jobs are due today."
                : `<ul>${due_log.map(job => `<li>${job}</li>`).join('')}</ul>`;


            // --- Populate participant dropdown ---
            const select = document.getElementById("participant-select");
            select.innerHTML = '<option value="">------Select------</option>'; // reset
            const participants = [...new Set(currentChores.map(entry => entry.assigned_to))];

            participants.forEach(name => {
                const option = document.createElement("option");
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            });

            // Attach listener once
            select.onchange = () => {
                const selected = select.value;
                showJobsForParticipant(currentChores, selected); //see this function above!
            };


            // --- Analytics section logic ---
            renderAnalytics(completedChores);
        }

        async function editChores() {
            const token = localStorage.getItem('idToken');
            if (!token) {
                alert("Please log in to edit chores.");
                return;
            }

            // Load chores from localStorage
            const stored = localStorage.getItem("currentChores");
            const chores = stored ? JSON.parse(stored) : [];

            // Populate dropdown
            const choreSelect = document.getElementById("choreIdSelect");
            choreSelect.innerHTML = ""; // clear old options
            chores.forEach(chore => {
                const opt = document.createElement("option");
                opt.value = chore.chore_id;
                opt.textContent = `${chore.chore_id} - ${chore.chore_name}`;
                choreSelect.appendChild(opt);
            });

            // Fill form fields when a chore is selected
            choreSelect.onchange = () => {
                const selectedId = parseInt(choreSelect.value, 10);
                const chore = chores.find(c => c.chore_id === selectedId);
                if (!chore) return;
                document.getElementById("choreName").value = chore.chore_name || "";
                document.getElementById("choreInstr").value = chore.instruction || "";
                document.getElementById("dueDate").value = chore.next_due || "";
                document.getElementById("interval").value = chore.interval_days || "";
                document.getElementById("assignedTo").value = chore.assigned_to || "";
                document.getElementById("theirEmail").value = chore.email || "";
            };

            //Attach submit handler only once
            const form = document.getElementById("updateChoreForm");
            form.onsubmit = async (e) => {
                e.preventDefault();

                const selectedId = parseInt(choreSelect.value, 10);
                const chore = chores.find(c => c.chore_id === selectedId);
                if (!chore) return;

                // Update fields
                chore.chore_name = document.getElementById("choreName").value;
                chore.instruction = document.getElementById("choreInstr").value;
                chore.next_due = document.getElementById("dueDate").value;
                chore.interval_days = parseInt(document.getElementById("interval").value, 10);
                chore.assigned_to = document.getElementById("assignedTo").value;
                chore.email = document.getElementById("theirEmail").value;
                chore.chore_status = "changed";
                chore.days_overdue = 0;

                try {
                    const response = await fetch(
                        "https://d75p3zw6y5.execute-api.us-east-2.amazonaws.com/prod/update-json",
                        {
                            method: "PUT",
                            headers: {
                                "Content-Type": "application/json",
                                "Authorization": `Bearer ${token}`
                            },
                            body: JSON.stringify(chore)
                        }
                    );

                    if (!response.ok) throw new Error("Failed to update chore");
                    const result = await response.json();
                    console.log("Success:", result);

                    showToast(`Chore ${chore.chore_id} was successfully updated ✅`);

                    // Now refresh after the update has finished
                    setTimeout(() => {
                        refreshUI();
                    }, 3000);

                } catch (error) {
                    console.error("Error:", error);
                    showToast("Error updating chore ❌");
                }
                const modalEl = document.getElementById('updateChoreModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();
                const form = document.getElementById("updateChoreForm");
                form.reset();
            };
        }

        async function deleteChores() {
            const token = localStorage.getItem('idToken');
            if (!token) {
                alert("Please log in to delete chores.");
                return;
            }
            // Load chores from localStorage
            const stored = localStorage.getItem("currentChores");
            const chores = stored ? JSON.parse(stored) : [];

            const deleteBtn = document.getElementById("deleteChoreBtn");
            deleteBtn.onclick = async (e) => {
                e.preventDefault();

                const selectedId = parseInt(document.getElementById("choreIdSelect").value, 10);
                const chore = chores.find(c => c.chore_id === selectedId);
                if (!chore) return;

                // Mark chore as deleted
                chore.chore_name = document.getElementById("choreName").value;
                chore.instruction = document.getElementById("choreInstr").value;
                chore.next_due = document.getElementById("dueDate").value;
                chore.interval_days = parseInt(document.getElementById("interval").value, 10);
                chore.assigned_to = document.getElementById("assignedTo").value;
                chore.email = document.getElementById("theirEmail").value;
                chore.chore_status = "delete";
                chore.days_overdue = 0;

                try {
                    const response = await fetch(
                        "https://d75p3zw6y5.execute-api.us-east-2.amazonaws.com/prod/update-json",
                        {
                            method: "PUT",
                            headers: {
                                "Content-Type": "application/json",
                                "Authorization": `Bearer ${token}`
                            },
                            body: JSON.stringify(chore)
                        }
                    );

                    if (!response.ok) throw new Error("Failed to delete chore");
                    const result = await response.json();
                    console.log("Success:", result);

                    showToast(`Chore ${chore.chore_id} was successfully deleted ✅`);

                    // Now refresh after the update has finished
                    setTimeout(() => {
                        refreshUI();
                    }, 3000);

                } catch (error) {
                    console.error("Error:", error);
                    showToast("Error deleting chore ❌");
                }
                const modalEl = document.getElementById('updateChoreModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();
                const form = document.getElementById("updateChoreForm");
                form.reset();
            };
        }

        async function createNewChores() {
            const token = localStorage.getItem('idToken')
            if (!token) {
                alert("Please log in to add new chores.");
                return;
            }
            // Restrict due date to tomorrow or later
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const yyyy = tomorrow.getFullYear();
            const mm = String(tomorrow.getMonth() + 1).padStart(2, '0');
            const dd = String(tomorrow.getDate()).padStart(2, '0');
            const minDate = `${yyyy}-${mm}-${dd}`;
            document.getElementById("dueDateNew").setAttribute("min", minDate);

            // Find max chore_id from current data in localStorage
            const stored = localStorage.getItem("currentChores");
            const allChores = stored ? JSON.parse(stored) : [];
            let maxId = allChores.length > 0 ? Math.max(...allChores.map(c => Number(c.chore_id))) : 0;

            // Pre-fill next chore ID
            document.getElementById("choreIdNew").value = maxId + 1;

            // Attach listener only once
            const form = document.getElementById("addChoreForm");
            form.onsubmit = async (e) => {
                e.preventDefault();

                const newChore = {
                    chore_id: parseInt(document.getElementById("choreIdNew").value, 10),
                    chore_name: document.getElementById("choreNameNew").value,
                    instruction: document.getElementById("choreInstrNew").value,
                    next_due: document.getElementById("dueDateNew").value,
                    interval_days: parseInt(document.getElementById("intervalNew").value, 10),
                    assigned_to: document.getElementById("assignedToNew").value,
                    email: document.getElementById("theirEmailNew").value,
                    chore_status: "new",
                    days_overdue: 0
                };

                try {
                    const response = await fetch(
                        "https://d75p3zw6y5.execute-api.us-east-2.amazonaws.com/prod/update-json",
                        {
                            method: "PUT",
                            headers: {
                                "Content-Type": "application/json",
                                "Authorization": `Bearer ${token}`
                            },
                            body: JSON.stringify(newChore)
                        }
                    );

                    if (!response.ok) throw new Error("Failed to save chore");
                    const result = await response.json();
                    console.log("Success saving new chore:", result);

                    showToast(`New chore ${newChore.chore_id} was successfully saved ✅`);

                    // Now refresh after the update has finished
                    setTimeout(() => {
                        refreshUI();
                    }, 3000);

                } catch (error) {
                    console.error("Error:", error);
                    showToast("Error saving chore ❌");
                }
                const modalEl = document.getElementById('addChoreModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();
                const form = document.getElementById("addChoreForm");
                form.reset();
            };
        }

        function renderAnalytics(completedChores) {
            // Destroy old charts if they exist
            if (choresByPersonChart) {
                choresByPersonChart.destroy();
            }
            if (choresOverTimeChart) {
                choresOverTimeChart.destroy();
            }
            if (avgCompletionChart) {
                avgCompletionChart.destroy();
            }
            // Prepare data
            const choresByPerson = {};
            const choresByDate = {};
            const completionTimes = {};
            completedChores.forEach(chore => {
                const person = chore.assigned_to;
                const date = chore.completed_on; // assumes YYYY-MM-DD
                const days = parseInt(chore.completed_with_DOD || 0);
                choresByPerson[person] = (choresByPerson[person] || 0) + 1;
                choresByDate[date] = (choresByDate[date] || 0) + 1;
                if (!completionTimes[person]) completionTimes[person] = [];
                completionTimes[person].push(days);
            });

            const avgCompletion = {};
            Object.keys(completionTimes).forEach(person => {
                const times = completionTimes[person];
                avgCompletion[person] = times.reduce((a, b) => a + b, 0) / times.length;
            });
            const sortedParticipants = Object.entries(avgCompletion)
                .sort((a, b) => a[1] - b[1]); // ascending order

            // Convert to array of [date, count]
            const choresArray = Object.entries(choresByDate);
            // Sort chronologically
            choresArray.sort((a, b) => new Date(a[0]) - new Date(b[0]));
            // Separate into labels and values
            const labels = choresArray.map(([date]) => date);
            const values = choresArray.map(([_, count]) => count);

            // Render charts
            choresByPersonChart = new Chart(document.getElementById("choresByPerson"), {
                type: "bar",
                data: {
                    labels: Object.keys(choresByPerson),
                    datasets: [{
                        label: "Chores Completed",
                        data: Object.values(choresByPerson),
                        backgroundColor: "rgba(75, 192, 192, 0.6)"
                    }]
                }
            });

            choresOverTimeChart = new Chart(document.getElementById("choresOverTime"), {
                type: "line",
                data: {
                    labels: labels,
                    datasets: [{
                        label: "Chores Completed",
                        data: values,
                        borderColor: "rgba(153, 102, 255, 1)",
                        fill: false
                    }]
                },
                options: {
                    scales: {
                        x: {
                            title: { display: true, text: "Date" }
                        },
                        y: {
                            title: { display: true, text: "Chores Completed" },
                            beginAtZero: true
                        }
                    }
                }
            });

            avgCompletionChart = new Chart(document.getElementById("avgCompletion"), {
                type: "bar",
                data: {
                    labels: sortedParticipants.map(([person]) => person),
                    datasets: [{
                        label: "Avg Days to Complete",
                        data: sortedParticipants.map(([_, avg]) => avg),
                        backgroundColor: "rgba(54, 162, 235, 0.6)"
                    }]
                },
                options: {
                    indexAxis: 'y', // horizontal bars
                    scales: {
                        x: {
                            title: { display: true, text: "Days" }
                        }
                    }
                }
            });
        }

        // --- Function to handle expired token ---
        function isTokenExpired(token) {
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                const now = Math.floor(Date.now() / 1000);
                return payload.exp < now;
            } catch (e) {
                return true; // treat invalid token as expired
            }
        }

        // --- Main function is here ---
        async function init() {
            // Clear local storage just in case
            localStorage.removeItem('idToken');
            localStorage.removeItem("currentChores");
            localStorage.removeItem("completedChores");

            // Get the token and save it to local
            const token = getTokenFromUrl();
            if (!token) {
                // No token at all
                alert("Please sign in first!");
                return;
            } else if (isTokenExpired(token)) {
                // Token exists but is expired
                alert("Your session has expired. Redirecting to login...");
                window.location.href = "/login"; // or your auth provider’s login URL
                return;
            }
            localStorage.setItem("idToken", token);

            // Fetch and render chores
            await refreshUI();

            // Attach CRUD handlers once
            createNewChores();
            editChores();
            deleteChores();

            // Logout logic
            document.getElementById('logoutBtn').addEventListener('click', () => {
                // Clear token/session and the chores data
                localStorage.removeItem('idToken');
                localStorage.removeItem("currentChores");
                localStorage.removeItem("completedChores");
                // Redirect to homepage or login
                window.location.href = 'https://kamarkseit.github.io/project-chores/';
            });
        }

        //-----------------------------------------------End of all functions-------------------------------------------
        // Running the main function and global references
        let choresByPersonChart = null;
        let choresOverTimeChart = null;
        let avgCompletionChart = null;
        document.addEventListener("DOMContentLoaded", () => {
            init(); // run once when the DOM is ready
        });
    </script>
    <div class="toast-container position-fixed bottom-0 end-0 p-3"></div>
    <div id="loading-overlay">
        <div class="loader"></div>
    </div>
</body>

</html>