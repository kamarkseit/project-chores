<!DOCTYPE html>
<html>

<head>
    <title>Family Chores</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="bootstrap.min.css">
    <script src="bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>




<body class="bg-light">
    <div class="container py-4">

        <!-- Project Info -->
        <div class="mb-4">
            <p>
                For more information about this project, please visit
                <a href="https://github.com/kamarkseit/project-chores.git" target="_blank" class="link-primary">
                    my GitHub page
                </a>.
            </p>
            <button class="btn btn-primary"
                onclick="window.location.href='https://us-east-2kycpqllvh.auth.us-east-2.amazoncognito.com/login?client_id=2u8c3k58lg83f0blfqn65vbnrf&response_type=token&scope=email+openid+phone&redirect_uri=https%3A%2F%2Fkamarkseit.github.io%2Fproject-chores%2F'">
                Login
            </button>
            <button class="btn btn-secondary" id="logoutBtn">
                Logout
            </button>

        </div>

        <div class="row">
            <!-- History Log -->
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h1 class="h4 mb-0">History Log</h1>
                    </div>
                    <div class="card-body">
                        <p class="mb-2">Please see all chores completed this month.</p>
                        <div id="history-log" class="alert alert-warning">Please login.</div>
                    </div>
                </div>
            </div>

            <!-- Due Chores Log -->
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header bg-danger text-white">
                        <h1 class="h4 mb-0">Due Chores</h1>
                    </div>
                    <div class="card-body">
                        <p class="mb-2">These chores are currently due or overdue.</p>
                        <div id="due-chores-log" class="alert alert-warning">Please login.</div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Job Update Section -->
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h2 class="h5 mb-0">Update My Job</h2>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="participant-select" class="form-label">Choose a participant:</label>
                    <select id="participant-select" class="form-select">
                        <option value="">------Select------</option>
                    </select>
                </div>
                <div id="job-update-area"></div>
            </div>
        </div>


        <!-- Analytics Section -->
        <div class="card mt-4">
            <div class="card-header bg-info text-white">
                <h2 class="h5 mb-0">Analytics</h2>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Chart 1 -->
                    <div class="col-md-6 mb-4">
                        <canvas id="choresByPerson"></canvas>
                    </div>
                    <!-- Chart 2 -->
                    <div class="col-md-6 mb-4">
                        <canvas id="choresOverTime"></canvas>
                    </div>
                </div>
                <div class="row">
                    <!-- Chart 3 -->
                    <div class="col-md-12">
                        <canvas id="avgCompletion"></canvas>
                    </div>
                </div>
            </div>
        </div>

    </div>




    <script>
        // Get token from API Gateway and Cognito
        function getTokenFromUrl() {
            const hash = window.location.hash;
            return new URLSearchParams(hash.substring(1)).get('id_token');
        }
        // Fetch json data that is stored in S3 using API Gateway and Cognito
        async function fetchData() {
            const token = localStorage.getItem("idToken");
            if (!token) {
                alert("Please log in to view chores.");
                return;
            }

            try {
                const response = await fetch("https://d75p3zw6y5.execute-api.us-east-2.amazonaws.com/prod/update-json", {
                    method: "GET",
                    headers: {
                        'Content-Type': 'application/json',
                        "Authorization": `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    const data = result.chores;   // unified array with status field

                    // Separate current vs completed data
                    const currentChores = data.filter(chore => chore.status === "current");
                    const completedChores = data.filter(chore => chore.status === "completed");

                    localStorage.setItem("currentChores", JSON.stringify(currentChores));
                    localStorage.setItem("completedChores", JSON.stringify(completedChores));

                    // Check if stored data can be accessed 
                    const storedData = JSON.parse(localStorage.getItem("currentChores"));
                    pollForResults();
                }
            } catch (err) {
                console.log("Error fetching data.");
            }
        }
        // Gets the token and fetchs json data 
        async function ensureLocalChores() {
            localStorage.removeItem("currentChores");
            const token = getTokenFromUrl();
            if (token) {
                localStorage.setItem("idToken", token);
                fetchData();
            } else {
                alert("Please login first!");
                return;
            }
        }

        // Function is used to modify data and send it to S3 using API Gateway
        function markComplete(jobId) {
            // Grab the Date Input Inside
            const input = document.getElementById(`date-${jobId}`);
            const newDate = input.value;
            if (!newDate) {
                alert("Please select a date.");
                return;
            }
            // Grab the data from local storage
            const stored = localStorage.getItem("currentChores");
            const parsed = stored ? JSON.parse(stored) : {};
            const data = Array.isArray(parsed) ? parsed : Object.values(parsed);
            // Recalculate the nextDue date
            const nextDue = new Date(newDate); // Convert string to Date object
            // Recalculate days that a completed chore was overdue before marked complete
            const nowCompleted = new Date(newDate);
            const msPerDay = 1000 * 60 * 60 * 24;

            // Update the values in the data
            const updated = data.map(entry => {
                if (entry.chore_id === jobId) {
                    const lastCompleted = new Date(entry.last_completed); // from JSON
                    const diffInDays = Math.floor((nowCompleted - lastCompleted) / msPerDay);
                    entry.last_completed_with_DOD = diffInDays;

                    entry.last_completed = newDate;
                    entry.chore_status = "complete";
                    nextDue.setDate(nextDue.getDate() + entry.interval_days); // Add interval
                    entry.next_due = nextDue.toISOString().split("T")[0]; // Format as "YYYY-MM-DD"
                    entry.days_overdue = 0;
                }
                return entry;
            });
            // Save updated data in local storage
            localStorage.setItem("currentChores", JSON.stringify(updated));
            alert(`Job ${jobId} updated!`);
            pollForResults();

            //11052025: sending only complete item to s3 instead of the entire chores.json:
            const updatedItem = updated.find(entry => entry.chore_id === jobId);

            // Send updated data to API
            const token = new URLSearchParams(window.location.hash.substring(1)).get('id_token')
            if (!token) {
                console.error("No token found. Please log in first.");
                return;
            }
            fetch('https://d75p3zw6y5.execute-api.us-east-2.amazonaws.com/prod/update-json', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(updatedItem) //11052025: updated -> updatedItem.
            })
                .then(response => response.json())
                .then(data => console.log('Success:', data))
                .catch(error => console.error('Error:', error));
        }

        function showJobsForParticipant(data, name) {
            const container = document.getElementById("job-update-area");
            container.innerHTML = ""; // Clear previous

            const jobs = data.filter(entry => entry.assigned_to === name && entry.chore_status === "due");

            if (jobs.length === 0) {
                container.textContent = "No jobs assigned to " + name;
                return;
            }

            jobs.forEach(job => {
                const today = new Date().toISOString().split('T')[0];
                const div = document.createElement("div");
                //markComplete is used below
                div.innerHTML = `
                    <p><strong>${job.chore_name}</strong> (Last done: ${job.last_completed})</p>
                    <label for="date-${job.chore_id}">Mark as complete:</label>
                    <input type="date" id="date-${job.chore_id}" max="${today}">
                    <button onclick="markComplete(${job.chore_id})">Update</button> 
                `;
                container.appendChild(div);
            });
        }

        async function tryFetch(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (err) {
                console.error("Fetch error:", err);
                return null;
            }
        }

        async function pollForResults() {
            const stored = localStorage.getItem("currentChores");
            const data = stored ? JSON.parse(stored) : [];

            // Find today's date, month, and year.
            const now = new Date();
            const currentMonth = now.getMonth(); // 0-indexed: October = 9
            const currentYear = now.getFullYear();

            // History log logic
            const history_log = [];
            data.forEach(entry => {
                const completedDate = new Date(entry.last_completed + "T00:00:00Z");
                if (
                    completedDate.getMonth() === currentMonth &&
                    completedDate.getFullYear() === currentYear
                ) {
                    history_log.push(`${entry.chore_name} on ${entry.last_completed}`);
                }
            });
            const container = document.getElementById("history-log");
            if (history_log.length === 0) {
                container.textContent = "No job was completed this month.";
            } else {
                const choreList = history_log
                    .map(job => `<li>${job}</li>`)
                    .join('');
                container.innerHTML = `<ul>${choreList}</ul>`;
            }

            // Due Chores log logic
            const due_log = [];
            data.forEach(entry => {
                const choreStatus = entry.chore_status;
                if (
                    choreStatus === "due"
                ) {
                    due_log.push(`${entry.chore_name} is ${entry.days_overdue} days overdue for ${entry.assigned_to}`);
                }
            });
            const container2 = document.getElementById("due-chores-log");
            if (due_log.length === 0) {
                container2.textContent = "No jobs are due today.";
            } else {
                const dueChoreList = due_log
                    .map(job => `<li>${job}</li>`)
                    .join('');
                container2.innerHTML = `<ul>${dueChoreList}</ul>`;
            }

            // Populate participant dropdown
            const participants = [...new Set(data.map(entry => entry.assigned_to))];
            const select = document.getElementById("participant-select");

            participants.forEach(name => {
                const option = document.createElement("option");
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            });

            // Add listener to show jobs when a name is selected
            select.addEventListener("change", () => {
                const selected = select.value;
                showJobsForParticipant(data, selected);
            });

            // Analytics section logic

            // Load completed chores from localStorage
            const storedCompleted = localStorage.getItem("completedChores");
            const completedChores = storedCompleted ? JSON.parse(storedCompleted) : [];

            // Prepare data
            const choresByPerson = {};
            const choresByDate = {};
            const completionTimes = {};

            completedChores.forEach(chore => {
                const person = chore.assigned_to;
                const date = chore.completed_on; // assumes YYYY-MM-DD
                const days = parseInt(chore.completed_with_DOD || 0);

                choresByPerson[person] = (choresByPerson[person] || 0) + 1;
                choresByDate[date] = (choresByDate[date] || 0) + 1;

                if (!completionTimes[person]) completionTimes[person] = [];
                completionTimes[person].push(days);
            });

            const avgCompletion = {};
            Object.keys(completionTimes).forEach(person => {
                const times = completionTimes[person];
                avgCompletion[person] = times.reduce((a, b) => a + b, 0) / times.length;
            });

            // Render charts
            new Chart(document.getElementById("choresByPerson"), {
                type: "bar",
                data: {
                    labels: Object.keys(choresByPerson),
                    datasets: [{
                        label: "Chores Completed",
                        data: Object.values(choresByPerson),
                        backgroundColor: "rgba(75, 192, 192, 0.6)"
                    }]
                }
            });

            new Chart(document.getElementById("choresOverTime"), {
                type: "line",
                data: {
                    labels: Object.keys(choresByDate).sort(), // sort dates
                    datasets: [{
                        label: "Chores Completed",
                        data: Object.values(choresByDate),
                        borderColor: "rgba(153, 102, 255, 1)",
                        fill: false
                    }]
                }
            });

            new Chart(document.getElementById("avgCompletion"), {
                type: "pie",
                data: {
                    labels: Object.keys(avgCompletion),
                    datasets: [{
                        label: "Avg Days to Complete",
                        data: Object.values(avgCompletion),
                        backgroundColor: ["#FF6384", "#36A2EB", "#FFCE56", "#4BC0C0"]
                    }]
                }
            });
        }

        // Main function is here
        async function init() {
            await ensureLocalChores(); // Waits for all internal async work
            pollForResults();          // Runs after chores are ensured
            // Logout logic
            document.getElementById('logoutBtn').addEventListener('click', () => {
                // Clear token/session and the chores data
                localStorage.removeItem('idToken');
                localStorage.removeItem("currentChores");
                // Redirect to homepage or login
                window.location.href = 'https://kamarkseit.github.io/project-chores/';
            });
        }
        // Running the main function
        init();


    </script>
</body>

</html>